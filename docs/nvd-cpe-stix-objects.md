# Modelling CPEs as STIX Objects

The STIX 2.1 Specification contains a Software SCO that can be used to construct these patterns, [here is the specification for it](https://docs.oasis-open.org/cti/stix/v2.1/csprd01/stix-v2.1-csprd01.html#_Toc16070740).

The problem here is CPEs cover applications (software), operating systems (also software), and hardware (not software).

As a trade-off to ensure consistency we decided to model all CPEs as Software SCOs regardless of whether they are software or not.

### New CPE Objects

cpe2stix constructs Software SCOs for CPEs as follows;

```json
{
    "type": "software",
    "spec_version": "2.1",
    "id": "software--<GENERATED BY STIX2 LIBRARY>",
    "name": "<cpes.titles.title>",
    "cpe": "<cpes.titles.cpe23Uri>",  
    "version": "<cpes.titles.cpe23Uri[version_section]>",
    "vendor": "<cpes.titles.cpe23Uri[vendor_section]>",
    "languages": [
        "<cpes.titles.lang>"
    ],
    "revoked": false
}
```

As an example using `cpe:2.3:a:rusqlite_project:rusqlite:0.26.0:*:*:*:*:rust:*:*`;

```json
{
    "type": "software",
    "spec_version": "2.1",
    "id": "software--bbac7ad2-a550-4d4e-af5c-78feaf455f77",
    "name": "Rusqlite Project Rusqlite 0.26.0 for Rust",
    "cpe": "cpe:2.3:a:rusqlite_project:rusqlite:0.26.0:*:*:*:*:rust:*:*",  
    "version": "0.26.0",
    "vendor": "rusqlite_project",
    "languages": [
        "*"
    ],
    "revoked": false
}
```

### Dealing with CPE updates

As noted CPEs can be periodically updated (generally this is to deprecate them).

If a CPE already exists but is returned by the NVD as updated (because `lastModifiedDate` > last run time) then cpe2stix updates the original object, but does not change the `id` property in most cases.

It is important to note in the [STIX specification for the Software Object](https://docs.oasis-open.org/cti/stix/v2.1/os/stix-v2.1-os.html#_7rkyhtkdthok) that the ID contributing properties for it are `name`, `cpe`, `swid` (not used by cpe2stix), `vendor`, `version`. As such, if any of these fields are changed during an update (mappings shown below), a new object with a new `id` will be created for the changes.

* `name` = `<cpes.titles.title>`
* `cpe` = `<cpes.titles.cpe23Uri>`
* `vendor` = `<cpes.titles.cpe23Uri[vendor_section]>`
* `version` = `<cpes.titles.cpe23Uri[version_section]>`

Usually if any of these fields are modified the object is deprecated, and a new entry created by NVD. Typically updates only happen to the `refs`, `deprecated`, `deprecatedBy`, and `vulnerabilities` properties -- the only one of which that impacts us is `deprecated`.

If the `deprecated` field changes then the `id` of the Software object remains the same, and the property updated. 

We don't immediatley update the updated Software objects (with different `deperecated` value) in all the `stix2_bundles` it is present in. The CVE bundle is regenerated everytime a CPE update happens. When the regeneration happens, the most recent software object is pulled in for the cpeuri.

This behaviour is important because means old CVEs (not updated) might contain out of date software objects.

Where a brand new Software object is generated because `name`, `cpe`, `vendor`, or `version` changes, then a new `id` is generated. In this case, this object is used for any references to the cpeuri when generating `stix2_bundles`. Again, the old `stix2_bundles` will not immeditaly be updated, however, on regeneration the new Software Object `id` will be pulled in, and the old Software Object removed.