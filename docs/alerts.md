# Mathcing

## Matching Overview

Once cve2stix has populated a database of CPEs, it is also possible to identify software vu

Essentially CPE takes a list of CPEs defined in a text file and compares them against CVEs downloads (specifically against the Indicator Objects).

Where a CVE contains a CPE that is present in the input file, a match is made.


When CVEs are ingested, alert Objects are also created to represent vulnerable CPEs using the following STIX Object

### Observed Data

For each `vulnerable_object_refs` Object in the CVE Indicator Object a corresponding Observed Data Object is created. Note

```json
        {
            "type": "observed-data",
            "spec_version": "2.1",
            "id": "observed-data--<GENERATED BY STIX2 LIBRARY>",
            "created_by_ref": "identity--<IDENTITY ID>",
            "created": "<CVE_Items.publishedDate>",
            "modified": "<CVE_Items.lastModifiedDate>",
            "first_observed": "<CVE_Items.publishedDate>",
            "last_observed": "<CVE_Items.publishedDate>",
            "number_observed": 1,
            "object_refs": [
                "software--<SCO ID THAT TRIGGERED ALERT>"
            ]
        }
```

### Sighting

A Sighting Object is also created to represent the alert

```json
        {
            "type": "sighting",
            "spec_version": "2.1",
            "id": "sighting--<GENERATED BY STIX2 LIBRARY>",
            "created_by_ref": "identity--<IDENTITY ID>",
            "created": "<CVE_Items.publishedDate>",
            "modified": "<CVE_Items.lastModifiedDate>",
            "sighting_of_ref": "indicator--<VULNERABILITY INDICATOR ID THAT TRIGGERED ALERT>",
            "observed_data_refs": [
                "observed-data--<OBSERVED DATA ID FOR ALERT>"
            ]
        }
```

### Grouping

Finally all alerts are grouped using a Grouping Object

```json
{
  "type": "grouping",
  "spec_version": "2.1",
  "id": "grouping--<GENERATED BY STIX2 LIBRARY>",
  "created_by_ref": "identity--<IDENTITY ID>",
  "created": "<CVE_Items.publishedDate>",
  "modified": "<CVE_Items.lastModifiedDate>",
  "name": "Alert: <UUID OF ALERT>",
  "description": "CPE Pattern Trigger: <CPE PATTERN THAT TRIGGERED ALERT>",
  "object_refs": [
    "<IDS OF ALL OBJECTS RELATED TO ALERT>"
  ]
}
```

In the Grouping `object_refs` Property all the Object related to the alert, that are;

* `vulnerability`: the CVE
* `indicator`: the CPE configuration that caused the alert (always only one of these Objects)
* `relationship`: linking `vulnerability` to `indicator`
* `identity`: one Identity Object
* `software`: the software SCO that triggered the alert
* `observed-data`: the Observed Data SDO for the Alert
* `sighting`: the Sighting Data SDO for the Alert
* All enrichment Objects
	* CAPEC `attack-patterns` (and `relationship`)
	* ATT&CK `attack-patterns` (and `relationship`)

## An example

If a CVE Vulnerability Object contained the following;

```
    "extensions": {
      "extension-definition--b76208eb-b943-4705-9fab-fffec50d030d": {
          "extension_type": "property-extension",
          "vulnerable_cpeid": [
          	"cpe:2.3:a:dell:powerscale_onefs:9.0.0:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.1.0:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.1.1:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.2.0:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.2.1:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.3.0:*:*:*:*:*:*:*"
          ],
        "vulnerable_object_refs": [
            "software--51aa29f1-9f74-41f1-a0ef-f2f58ef6acd2",
            "software--5ac7347b-062c-45f0-af4e-7b33fe3d4c1a",
            "software--c02b98ba-e120-441a-bafe-a7cadb0e0f73",
            "software--bf34ffc4-37f6-43cf-b9dd-f772c72d4ab3",
            "software--09daf266-c46b-45b5-8d30-5aaf153e43b3",
            "software--5f038772-836c-4544-96ca-81ee225f4ee6"
        ],
      }
    }
```

It would create 5 Observed Data, 5 Sighting and 5 Grouping Objects (because there are 5 `vulnerable_object_refs`).


## Match file

One of the main things a user will want is to understand what CVEs affect product(s) they use.

cve2stix allows a user to define a list of cpeuris that will create a bundle for each alert they are linked to.

In the match file a user can enter a full or partial match string (with a minimum of vendor and product supplied), e.g.

```
cpe:2.3:a:apple:icloud:*:*:*:*:*:windows:*:*
cpe:2.3:a:apple:icloud
```

In the case of partial match strings like `cpe:2.3:a:apple:icloud`, it the remaining properties are considered with `*` which turns it into `cpe:2.3:a:apple:icloud:*:*:*:*:*:windows:*:*`.

Each time the user runs the match command, the CPEs listed are considered against products marked as vulnerable inside an Indicator SDOs extensions.

For example,

```json
    "extensions": {
      "extension-definition--b76208eb-b943-4705-9fab-fffec50d030d": {
          "extension_type": "property-extension",
          "cpe_vulnerable": [
          	"cpe:2.3:a:dell:powerscale_onefs:9.0.0:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.1.0:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.1.1:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.2.0:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.2.1:*:*:*:*:*:*:*",
          	"cpe:2.3:a:dell:powerscale_onefs:9.3.0:*:*:*:*:*:*:*"
          ]
      }
    },
```

Everytime a 


A match file of 

```
cpe:2.3:a:dell:powerscale_onefs
```

Would match to all of these.

A match file of

```
cpe:2.3:a:dell:powerscale_onefs:9.0.0:*:*:*:*:*:*:*
```

Would match to one of these.

In both cases, only one alert would be generated

## Dealing with alerts

In Vulmatch, when an alert is raised both a Sighting SRO, Observed Data SDO, and Grouping SDO are created for it in the following format;


when an alert is raised both a Sighting SRO, Observed Data SDO, and Grouping SDO are created for it in the following format;

## STIX Representation of an alert



In the Grouping `object_refs` Property all the Object related to the alert, that are;

* `vulnerability`: the CVE
* `indicator`: the CPE configuration that caused the alert (always only one of these Objects)
* `relationship`: linking `vulnerability` to `indicator`
* `identity`: one Signals Corps Identity Object
* `software`: the software SCO that triggered the alert
* `observed-data`: the Observed Data SDO for the Alert
* `sighting`: the Sighting Data SDO for the Alert
* `relationship`: the Relationship object linking